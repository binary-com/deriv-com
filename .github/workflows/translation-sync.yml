name: Sync Master Translation

permissions:
  actions: write
  checks: write
  contents: write
  deployments: write
  pull-requests: write
  statuses: write
  
on:
  push:
    branches:
        - 'master*'
        
jobs:
    sync-translation:
        runs-on: ubuntu-latest
        steps:
            - name: Check Branch Name
              run: |
                if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/new_translation_strings" ]; then
                  echo "The branch recently merged to master is the branch came from this workflow, skipping further steps."
                  exit 0
                fi
            - name: Checkout üõéÔ∏è
              uses: actions/checkout@v2.3.1
            - name: Setup Node
              uses: actions/setup-node@v2.1.2
              with:
                  node-version: '18.x'
            - run: npm i -g @crowdin/cli@3.7.8
            - name: Fetch,Sync & Push Strings to Crowdin
              run: |
                # Download new translated strings
                echo 'Fetch Crowdin Master Translation ‚¨áÔ∏è'
                crowdin download -b  master -T ${{ secrets.CROWDIN_API_KEY }} && crowdin download -b master -l zh-CN -T ${{ secrets.CROWDIN_API_KEY }}

                if [ -n "$(git status --porcelain)" ]; then
                  # New strings are added, create a PR to update the master

                  branch_name="new_translation_strings"

                  echo "Setting up Git identity"
                  git config --global user.name "DerivFE"
                  git config --global user.email "80095553+DerivFE@users.noreply.github.com"

                  # Commit the newly downloaded files
                  cd $(git rev-parse --show-toplevel)
                  git add .

                  echo "Checking out new branch [$branch_name]"
                  git checkout -b "$branch_name"

                  # Force push to this branch in case a previous run created it.
                  git push --set-upstream origin "$branch_name" -f

                  sudo apt install gh
                  gh auth login --with-token <<< ${{ github.token }}
                  gh pr close "$branch_name" || true
                  gh pr create --base "master" --title "[Translations] New strings from crowdin üìö" --head "binary-com:$branch_name" --body "This is an automated pull request to fetch the newly translated strings from Crowdin to ensure that we do not overwrite the translations provided by the translation team before pushing our new strings."
                fi

                # Upload new strings to Crowdin
                crowdin upload sources -b master -T ${{ secrets.CROWDIN_API_KEY }}; crowdin upload translations -b master -T ${{ secrets.CROWDIN_API_KEY }}
            - name: Slack Notification üì£
              uses: 8398a7/action-slack@v3
              with:
                  status: custom
                  fields: workflow,job,commit,repo
                  custom_payload: |
                      {
                        attachments: [{
                          color: '${{ job.status }}' === 'success' ? 'good' : '${{ job.status }}' === 'failure' ? 'danger' : 'warning',
                          text: `*[Deriv.com]*  New strings are pushed to crowdin master branch:(https://crowdin.com/project/deriv-com/content/files)`
                        }]
                      }
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_TRANSLATION }}

