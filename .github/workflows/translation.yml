name: Release Translation

on:
    push:
        tags:
            - 'translation*'
        paths-ignore:
            - '**.md'

jobs:
    release-translation:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout üõéÔ∏è
              uses: actions/checkout@v2.3.1
              with:
                  ref: crowdin
                  token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

            - name: Setup Node
              uses: actions/setup-node@v2.1.2
              with:
                  node-version: '14.x'

            - run: npm i -g @crowdin/cli
            - run: npm ci

            - uses: olegtarasov/get-tag@v2.1
              id: tagName

            - name: Extract, Upload and Download from Crowdin Platform
              run: |
                  branch_name="deriv-com-translations"

                  echo "Setting up Git identity"
                  git config --global user.name "DerivFE"
                  git config --global user.email "80095553+DerivFE@users.noreply.github.com"

                  echo "Checking out new branch [$branch_name]"
                  git checkout -b "$branch_name"

                  echo "Running the translation script (extract-translations.js)"
                  npm run translate:extract

                  echo "Uploading source file to Crowdin"
                  crowdin upload sources -b crowdin -T ${{ secrets.CROWDIN_API_KEY }}

                  echo "Downloading translations from Crowdin"
                  crowdin download -b crowdin -T ${{ secrets.CROWDIN_API_KEY }}
                  crowdin download -b crowdin -l zh-CN -T ${{ secrets.CROWDIN_API_KEY }}

                  echo "Committing changes to deriv-com-translations branch"
                  git add -A
                  git commit -am "Update Translations üìö - $GIT_TAG_NAME"
                  git push origin HEAD:deriv-com-translations --force

                  echo "Creating new PR"
                  sudo apt install gh
                  gh auth login --with-token <<< ${{ secrets.PERSONAL_ACCESS_TOKEN }}
                  gh pr close "$branch_name" || true
                  gh pr create --fill --base "crowdin" --head "binary-com:$branch_name"
